<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Uke-A-Uke</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@2.3.0/dist/tus.min.js"></script>

  <style>
    /* --- ESTILOS VISUAIS --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Nunito Sans', sans-serif;
      background-color: transparent;
      color: #ffffff;
      padding: 0 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    .container { width: 100%; max-width: 100%; }

    /* Telas Animadas */
    #step-validation, #step-upload, #step-upsell, #step-success { display: none; animation: fadeIn 0.4s; }
    .active { display: block !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Inputs */
    .form-group { margin-bottom: 12px; width: 100%; }
    
    .form-input {
      width: 100%; padding: 14px; background-color: #333; border: 1px solid #555;
      border-radius: 6px; color: #fff; font-size: 15px; outline: none; transition: 0.2s;
    }
    .form-input:focus { border-color: #FF6D00; background-color: #404040; }
    .form-input.error { border-color: #ff4444; background-color: #3a2020; }
    .form-input::placeholder { color: #999; font-style: italic; }

    /* Bot√µes */
    .btn-main {
      width: 100%; padding: 14px; background-color: #FF6D00; color: #000;
      border: none; border-radius: 6px; cursor: pointer; font-weight: 800; font-size: 14px;
      text-transform: uppercase; transition: 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .btn-main:hover { background-color: #ff8533; transform: translateY(-1px); }
    .btn-main:disabled { background-color: #555; color: #888; cursor: wait; transform: none; }

    /* Upsell / Bloqueio */
    .upsell-box {
      background: #fff; color: #333; border-radius: 8px; padding: 20px; 
      text-align: center; border: 2px solid #ddd; margin-top: 10px;
    }
    .upsell-title { color: #d32f2f; font-weight: 800; font-size: 18px; margin-bottom: 10px; }
    .btn-upsell { 
      background-color: #27ae60; color: white; padding: 12px; border-radius: 5px; 
      text-decoration: none; display: inline-block; font-weight: bold; margin-top: 10px; 
    }
    .btn-retry { 
      background: none; border: none; color: #666; font-size: 12px; 
      margin-top: 15px; cursor: pointer; text-decoration: underline; 
    }

    /* Mensagens */
    .msg-box { margin-top: 10px; padding: 10px; border-radius: 5px; font-size: 13px; display: none; text-align: left; }
    .msg-error { background: rgba(255, 68, 68, 0.1); color: #ff8888; border: 1px solid #ff4444; display: block; }
    
    /* Upload UI */
    .welcome-msg { color: #FF6D00; font-weight: bold; margin-bottom: 5px; text-align: center; font-size: 16px; }
    .lesson-info { font-size: 13px; color: #ccc; text-align: center; margin-bottom: 15px; line-height: 1.4; }
    
    .progress-container { margin-top: 12px; }
    progress { width: 100%; height: 6px; border-radius: 3px; background: #444; border: none; }
    progress::-webkit-progress-value { background: #FF6D00; }
  </style>
</head>
<body>

  <div class="container">
    
    <!-- 1. TELA DE VALIDA√á√ÉO -->
    <div id="step-validation" class="active">
      <div class="form-group">
        <input type="email" id="emailInput" class="form-input" placeholder="Digite seu e-mail de aluno...">
      </div>
      <button id="btnValidate" class="btn-main" onclick="validateUser()">
        Validar Acesso
      </button>
      <div id="validationError" class="msg-box msg-error" style="display:none;"></div>
    </div>

    <!-- 2. TELA DE BLOQUEIO (UPSELL) -->
    <div id="step-upsell">
      <div class="upsell-box">
        <div class="upsell-title">üö´ Acesso n√£o encontrado</div>
        <p style="font-size:14px; line-height:1.4;">
          O e-mail <strong id="displayEmailUpsell"></strong> n√£o consta na nossa lista de alunos ativos.
        </p>
        <p style="font-size:12px; color:#555; margin-top:10px;">
          Verifique se digitou corretamente ou adquira o plano abaixo.
        </p>
        
        <!-- LINK DE VENDAS -->
        <a href="https://clubedoukulele.com" target="_blank" class="btn-upsell">Quero ser Aluno</a>
        <br>
        <button class="btn-retry" onclick="resetView()">Tentar outro e-mail</button>
      </div>
    </div>

    <!-- 3. TELA DE UPLOAD (LIBERADO) -->
    <div id="step-upload">
      <div class="welcome-msg">üëã Ol√°, <span id="studentNameDisplay">Aluno</span>!</div>
      <p class="lesson-info">
        Enviar v√≠deo para:<br>
        <strong style="color:#fff;" id="lessonNameDisplay">...</strong>
      </p>

      <label for="fileInput" class="btn-main">
        <span style="margin-right:8px; font-size:18px;">üìÅ</span> SELECIONAR V√çDEO
      </label>
      <input id="fileInput" type="file" accept="video/*" style="display:none;" />

      <div id="progressArea" class="progress-container" style="display:none;">
        <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px; color:#FF6D00;">
          <span>Enviando...</span><span id="percentageText">0%</span>
        </div>
        <progress id="progressBar" value="0" max="100"></progress>
      </div>
      
      <div id="uploadError" class="msg-box msg-error" style="display:none;"></div>
    </div>

    <!-- 4. TELA DE SUCESSO -->
    <div id="step-success">
      <div style="background:#333; border:1px solid #4caf50; padding:15px; border-radius:8px; display:flex; align-items:center; margin-top:5px;">
        <div style="font-size:24px; margin-right:15px; color:#4caf50;">‚úÖ</div>
        <div>
          <h3 style="color:#4caf50; font-size:16px; margin:0 0 5px 0;">V√≠deo Enviado!</h3>
          <p style="color:#ddd; font-size:12px; line-height:1.3; margin:0;">
            Recebemos seu arquivo.<br>Aguarde a an√°lise.
          </p>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================================================
    // CONFIGURA√á√ïES
    // =========================================================
    
    // URL DO APPS SCRIPT (ATUALIZADA)
    const API_URL = "https://script.google.com/macros/s/AKfycbypzt5_0sxbVkS-MM_CJjO9xFY0peVrMqUDa5uq7L44LdQKCBoK99x3gGt75Ns2wjYN8g/exec"; 
    
    // URL DO TUS
    const TUS_ENDPOINT = "https://tus-upload-server-1019908552664.southamerica-east1.run.app/files/";

    // =========================================================

    // Vari√°veis Globais
    let currentStudentName = "";
    let currentStudentEmail = "";
    let currentLesson = "Aula Geral";

    // Pega nome da aula da URL (?aula=...)
    const params = new URLSearchParams(window.location.search);
    if(params.get('aula')) currentLesson = params.get('aula');

    // Mapeamento dos elementos da tela
    const views = {
      val: document.getElementById('step-validation'),
      upsell: document.getElementById('step-upsell'),
      upload: document.getElementById('step-upload'),
      success: document.getElementById('step-success')
    };
    
    const els = {
      email: document.getElementById('emailInput'),
      btnVal: document.getElementById('btnValidate'),
      valErr: document.getElementById('validationError'),
      nameDisplay: document.getElementById('studentNameDisplay'),
      lessonDisplay: document.getElementById('lessonNameDisplay'),
      file: document.getElementById('fileInput'),
      bar: document.getElementById('progressBar'),
      txt: document.getElementById('percentageText'),
      prog: document.getElementById('progressArea'),
      upErr: document.getElementById('uploadError')
    };

    els.lessonDisplay.innerText = currentLesson;

    // --- TROCA DE TELAS ---
    function showView(name) {
      Object.values(views).forEach(el => el.classList.remove('active'));
      views[name].classList.add('active');
    }

    function resetView() {
      els.email.value = "";
      els.valErr.style.display = 'none';
      showView('val');
    }

    // --- VALIDA√á√ÉO DE DIGITA√á√ÉO ---
    function checkTypos(email) {
      const typos = [
        '@gmial', '@gamil', '@gmal', '@gmai.', '@gmaill', '@g-mail', 
        '@hotmial', '@hotmil', '@hormail', '@hotnail', '@hotmaill', 
        '@outlok', '@otlook', '@yaho.', '@yahooo', '@icoud', 
        '.cmo', '.con', '.coom', '.combr', '.br.com', 'gmail.com.br'
      ];
      for (let t of typos) {
        if (email.includes(t)) return t;
      }
      return null;
    }

    // --- L√ìGICA DE VALIDA√á√ÉO DO ALUNO (Frontend -> Apps Script) ---
    async function validateUser() {
      const email = els.email.value.trim().toLowerCase();
      els.valErr.style.display = 'none';
      els.email.classList.remove('error');

      // 1. Valida√ß√£o simples local
      if (!email || !email.includes('@') || !email.includes('.')) {
        els.valErr.innerText = "‚ö†Ô∏è E-mail inv√°lido.";
        els.valErr.style.display = 'block';
        return;
      }

      const typo = checkTypos(email);
      if (typo) {
        els.valErr.innerHTML = `‚ö†Ô∏è Erro de digita√ß√£o comum: <strong>${typo}</strong>? Corrija e tente novamente.`;
        els.valErr.style.display = 'block';
        return;
      }

      // 2. Loading...
      els.btnVal.disabled = true;
      els.btnVal.innerText = "Verificando...";

      try {
        // 3. Consulta a Planilha
        const res = await fetch(`${API_URL}?email=${encodeURIComponent(email)}`);
        const data = await res.json();

        if (data.valid) {
          // SUCESSO: Aluno existe
          currentStudentName = data.name; 
          currentStudentEmail = email;
          
          // Mostra apenas o primeiro nome para ficar pessoal
          els.nameDisplay.innerText = currentStudentName.split(' ')[0]; 
          showView('upload');
        } else {
          // ERRO: N√£o existe
          document.getElementById('displayEmailUpsell').innerText = email;
          showView('upsell');
        }

      } catch (err) {
        console.error(err);
        els.valErr.innerText = "‚ùå Erro ao conectar. Tente novamente.";
        els.valErr.style.display = 'block';
      } finally {
        els.btnVal.disabled = false;
        els.btnVal.innerText = "Validar Acesso";
      }
    }

    // --- L√ìGICA DE UPLOAD (TUS) ---
    els.file.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Prepara interface
      els.prog.style.display = 'block';
      els.upErr.style.display = 'none';
      // Esconde o bot√£o para evitar clique duplo
      document.querySelector("label[for='fileInput']").style.display = 'none'; 

      const upload = new tus.Upload(file, {
        endpoint: TUS_ENDPOINT,
        chunkSize: 10485760, // 10MB
        metadata: {
          filename: file.name,
          filetype: file.type,
          // AQUI EST√Å O SEGREDO: Usamos os dados validados anteriormente
          student_name: currentStudentName,
          student_email: currentStudentEmail,
          lesson: currentLesson,
          upload_date: new Date().toISOString()
        },
        onError: (error) => {
          console.error("Failed because: " + error);
          els.upErr.innerText = "‚ùå Falha no envio. Verifique sua conex√£o.";
          els.upErr.style.display = 'block';
          // Mostra o bot√£o de novo para ele tentar novamente
          document.querySelector("label[for='fileInput']").style.display = 'flex'; 
        },
        onProgress: (bytesUploaded, bytesTotal) => {
          var percentage = (bytesUploaded / bytesTotal * 100).toFixed(0);
          els.bar.value = percentage;
          els.txt.innerText = percentage + "%";
        },
        onSuccess: () => {
          showView('success');
        }
      });

      upload.start();
    });

  </script>
</body>
</html>
