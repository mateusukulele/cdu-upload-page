<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Uke-A-Uke</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@2.3.0/dist/tus.min.js"></script>

  <style>
    /* --- RESET & FONTS --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Nunito Sans', sans-serif; /* Fonte Nativa Hotmart */
      background-color: transparent; 
      color: #ffffff; /* Texto padr√£o branco */
      padding: 0 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    .container { width: 100%; max-width: 100%; margin-top: 15px; /* Padding solicitado */ }

    /* ANIMA√á√ïES */
    #step-validation, #step-upload, #step-upsell, #step-success { display: none; animation: fadeIn 0.4s ease-out; }
    .active { display: block !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* INPUTS (Visual Dark/Clean) */
    .form-group { margin-bottom: 12px; width: 100%; }
    
    .form-input {
      width: 100%; padding: 14px 16px; 
      background-color: rgba(255,255,255, 0.1); /* Leve transpar√™ncia */
      border: 1px solid #444;
      border-radius: 4px; /* Bordas levemente arredondadas como Hotmart */
      color: #fff; font-size: 15px; outline: none; transition: 0.2s;
    }
    .form-input:focus { border-color: #FF6D00; background-color: rgba(255,255,255, 0.15); }
    .form-input.error { border-color: #e53935; background-color: rgba(229, 57, 53, 0.1); }
    .form-input::placeholder { color: #888; }

    /* BOT√ïES */
    .btn-main {
      width: 100%; padding: 14px; 
      background-color: #FF6D00; color: #fff;
      border: none; border-radius: 4px; 
      cursor: pointer; font-weight: 700; font-size: 14px; /* Peso da fonte ajustado */
      text-transform: uppercase; letter-spacing: 0.5px;
      transition: 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .btn-main:hover { background-color: #e65100; transform: translateY(-1px); }
    .btn-main:disabled { background-color: #555; color: #aaa; cursor: wait; transform: none; }

    /* TELA DE ERRO (Seamless/Transparente) */
    .error-container {
      text-align: center;
      padding: 10px 0;
    }
    .error-title { color: #e53935; font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .error-email { color: #fff; font-weight: 400; font-size: 15px; margin-bottom: 5px; display: block; word-break: break-all;}
    .error-desc { color: #ccc; font-size: 13px; line-height: 1.4; margin-bottom: 15px; }
    .btn-retry { 
      background: transparent; border: 1px solid #666; color: #ccc; 
      padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s;
    }
    .btn-retry:hover { border-color: #FF6D00; color: #FF6D00; }

    /* MENSAGENS FLUTUANTES */
    .msg-box { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 13px; display: none; text-align: left; }
    .msg-error { background: rgba(229, 57, 53, 0.15); color: #ffcdd2; border: 1px solid #e53935; }
    
    /* UPLOAD UI */
    .welcome-msg { color: #FF6D00; font-weight: 700; margin-bottom: 5px; text-align: center; font-size: 16px; }
    .lesson-info { font-size: 13px; color: #bbb; text-align: center; margin-bottom: 20px; }
    
    .progress-container { margin-top: 15px; }
    progress { width: 100%; height: 6px; border-radius: 3px; background: #333; border: none; }
    progress::-webkit-progress-value { background: #FF6D00; border-radius: 3px; }

  </style>
</head>
<body>

  <div class="container">
    
    <!-- 1. TELA: INPUT LIMPO -->
    <div id="step-validation" class="active">
      <div class="form-group">
        <input type="email" id="emailInput" class="form-input" placeholder="Digite seu e-mail de acesso...">
      </div>
      
      <button id="btnValidate" class="btn-main" onclick="validateUser()">
        Continuar com meu e-mail
      </button>
      
      <div id="validationError" class="msg-box msg-error"></div>
    </div>

    <!-- 2. TELA: ERRO (SEAMLESS) -->
    <div id="step-upsell">
      <div class="error-container">
        <div class="error-title">ü§î N√£o encontramos...</div>
        <span class="error-email" id="displayEmailUpsell"></span>
        <p class="error-desc">
          Verifique se digitou corretamente.<br>Use o mesmo e-mail da sua compra.
        </p>
        <button class="btn-retry" onclick="resetView()">Digitar novamente</button>
      </div>
    </div>

    <!-- 3. TELA: UPLOAD -->
    <div id="step-upload">
      <div class="welcome-msg">Ol√°, <span id="studentNameDisplay">Aluno</span>!</div>
      <p class="lesson-info">
        Envio para: <strong style="color:#fff;" id="lessonNameDisplay">...</strong>
      </p>

      <label for="fileInput" class="btn-main">
        <span style="margin-right:10px; font-size:18px;">üé¨</span> SELECIONAR V√çDEO
      </label>
      <input id="fileInput" type="file" accept="video/*" style="display:none;" />

      <div id="progressArea" class="progress-container" style="display:none;">
        <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:4px; color:#FF6D00;">
          <span>Enviando atividade...</span><span id="percentageText">0%</span>
        </div>
        <progress id="progressBar" value="0" max="100"></progress>
      </div>
      
      <div id="uploadError" class="msg-box msg-error" style="display:none;"></div>
    </div>

    <!-- 4. TELA: SUCESSO -->
    <div id="step-success">
      <div style="background:rgba(46, 125, 50, 0.2); border:1px solid #2e7d32; padding:15px; border-radius:4px; text-align:center;">
        <div style="font-size:32px; margin-bottom:8px;">‚úÖ</div>
        <h3 style="color:#fff; margin:0 0 5px 0; font-size:16px;">Atividade Enviada!</h3>
        <p style="color:#c8e6c9; font-size:13px;">J√° recebemos. Fique de olho no seu Zap/Email.</p>
      </div>
    </div>

  </div>

  <script>
    // --- CONFIGURA√á√ïES ---
    const API_URL = "https://script.google.com/macros/s/AKfycbypzt5_0sxbVkS-MM_CJjO9xFY0peVrMqUDa5uq7L44LdQKCBoK99x3gGt75Ns2wjYN8g/exec"; 
    const TUS_ENDPOINT = "https://tus-upload-server-1019908552664.southamerica-east1.run.app/files/";

    let currentStudentName = "", currentStudentEmail = "", currentLesson = "Atividade Geral";
    const params = new URLSearchParams(window.location.search);
    if(params.get('aula')) currentLesson = params.get('aula');

    const els = {
      email: document.getElementById('emailInput'),
      btnVal: document.getElementById('btnValidate'),
      valErr: document.getElementById('validationError'),
      nameDisplay: document.getElementById('studentNameDisplay'),
      lessonDisplay: document.getElementById('lessonNameDisplay'),
      file: document.getElementById('fileInput'),
      bar: document.getElementById('progressBar'),
      txt: document.getElementById('percentageText'),
      prog: document.getElementById('progressArea'),
      upErr: document.getElementById('uploadError'),
      upsellEmail: document.getElementById('displayEmailUpsell')
    };
    els.lessonDisplay.innerText = currentLesson;

    function showView(name) {
      ['step-validation', 'step-upsell', 'step-upload', 'step-success'].forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('step-' + name).classList.add('active');
    }

    function resetView() {
      els.email.value = "";
      els.valErr.style.display = 'none';
      showView('validation');
      // Foca no input novamente para UX fluida
      setTimeout(() => els.email.focus(), 100);
    }

    function checkTypos(email) {
      const typos = ['@gmial', '@gamil', '@gmal', '@hotmial', '@hotmil', '@outlok', '.cmo', '.combr', 'gmail.com.br'];
      for (let t of typos) { if (email.includes(t)) return t; }
      return null;
    }

    async function validateUser() {
      const email = els.email.value.trim().toLowerCase();
      els.valErr.style.display = 'none';
      els.email.classList.remove('error');

      if (!email.includes('@') || !email.includes('.')) { 
        els.valErr.innerText = "‚ö†Ô∏è E-mail inv√°lido"; 
        els.valErr.style.display = 'block'; 
        return; 
      }

      const typo = checkTypos(email);
      if (typo) {
        els.valErr.innerHTML = `‚ö†Ô∏è Voc√™ quis dizer <strong>${typo}</strong>?`;
        els.valErr.style.display = 'block';
        return;
      }

      // UX: Mudan√ßa de texto no bot√£o
      const originalText = els.btnVal.innerText;
      els.btnVal.disabled = true;
      els.btnVal.innerText = "Ativando o envio da sua atividade..."; // Frase solicitada

      try {
        const res = await fetch(`${API_URL}?email=${encodeURIComponent(email)}`);
        const data = await res.json();

        if (data.valid) {
          currentStudentName = data.name; 
          currentStudentEmail = email;
          els.nameDisplay.innerText = currentStudentName.split(' ')[0];
          showView('upload');
        } else {
          els.upsellEmail.innerText = email;
          showView('upsell');
        }
      } catch (err) {
        els.valErr.innerText = "‚ùå Erro de conex√£o";
        els.valErr.style.display = 'block';
      } finally {
        els.btnVal.disabled = false;
        els.btnVal.innerText = originalText;
      }
    }

    els.file.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      els.prog.style.display = 'block'; 
      els.upErr.style.display = 'none'; 
      document.querySelector("label[for='fileInput']").style.display = 'none';
      
      const upload = new tus.Upload(file, {
        endpoint: TUS_ENDPOINT,
        chunkSize: 10485760,
        metadata: { filename: file.name, filetype: file.type, student_name: currentStudentName, student_email: currentStudentEmail, lesson: currentLesson, upload_date: new Date().toISOString() },
        onError: (err) => { 
            console.error(err); 
            els.upErr.innerText = "‚ùå Falha no envio. Tente novamente."; 
            els.upErr.style.display = 'block'; 
            document.querySelector("label[for='fileInput']").style.display = 'flex'; 
        },
        onProgress: (u, t) => { let p = ((u/t)*100).toFixed(0); els.bar.value = p; els.txt.innerText = p+"%"; },
        onSuccess: () => showView('success')
      });
      upload.start();
    });
  </script>
</body>
</html>
