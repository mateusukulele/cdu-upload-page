<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Uke-A-Uke</title>
  
  <!-- Fontes e Biblioteca de Upload -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tus-js-client@2.3.0/dist/tus.min.js"></script>

  <style>
    /* --- ESTILOS VISUAIS (Beleza e UX) --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Nunito Sans', sans-serif;
      background-color: transparent; /* Fundo transparente para integrar na Hotmart */
      color: #ffffff;
      padding: 0 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }

    .container { width: 100%; max-width: 100%; }

    /* Anima√ß√£o suave entre as etapas */
    #step-validation, #step-upload, #step-upsell, #step-success { display: none; animation: fadeIn 0.5s ease-in-out; }
    .active { display: block !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Caixas de Texto (Inputs) */
    .form-group { margin-bottom: 15px; width: 100%; }
    
    .form-input {
      width: 100%; padding: 16px; 
      background-color: #333; 
      border: 1px solid #555;
      border-radius: 8px; 
      color: #fff; font-size: 16px; outline: none; transition: 0.3s;
    }
    .form-input:focus { border-color: #FF6D00; background-color: #404040; box-shadow: 0 0 8px rgba(255, 109, 0, 0.2); }
    .form-input.error { border-color: #ff4444; background-color: #3a2020; }
    .form-input::placeholder { color: #aaa; }

    /* Bot√µes Principais */
    .btn-main {
      width: 100%; padding: 16px; 
      background-color: #FF6D00; color: #fff;
      border: none; border-radius: 8px; 
      cursor: pointer; font-weight: 800; font-size: 16px;
      text-transform: uppercase; letter-spacing: 0.5px;
      transition: 0.3s; display: flex; align-items: center; justify-content: center;
    }
    .btn-main:hover { background-color: #e65100; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 109, 0, 0.3); }
    .btn-main:disabled { background-color: #555; color: #888; cursor: wait; transform: none; box-shadow: none; }

    /* Mensagens de Erro */
    .msg-box { margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 14px; display: none; text-align: left; line-height: 1.5; }
    .msg-error { background: rgba(255, 68, 68, 0.15); color: #ffadad; border: 1px solid #ff4444; display: block; }
    
    /* Upload UI */
    .welcome-msg { color: #FF6D00; font-weight: 800; margin-bottom: 5px; text-align: center; font-size: 18px; }
    .lesson-info { font-size: 14px; color: #ccc; text-align: center; margin-bottom: 20px; line-height: 1.4; }
    
    .progress-container { margin-top: 15px; }
    progress { width: 100%; height: 8px; border-radius: 4px; background: #444; border: none; }
    progress::-webkit-progress-value { background: #FF6D00; border-radius: 4px; }
    
    /* Tela de Ajuda (Quando n√£o acha o email) */
    .upsell-box { background: #fff; color: #333; border-radius: 8px; padding: 25px; text-align: center; border: 2px solid #ddd; margin-top: 10px; }
    .upsell-title { color: #d32f2f; font-weight: 900; font-size: 18px; margin-bottom: 10px; }
    .btn-retry { background: none; border: none; color: #666; font-size: 14px; margin-top: 20px; cursor: pointer; text-decoration: underline; font-weight: bold; }

  </style>
</head>
<body>

  <div class="container">
    
    <!-- 1. TELA: IDENTIFICA√á√ÉO -->
    <div id="step-validation" class="active">
      <div style="text-align:center; margin-bottom:20px;">
        <p style="font-size:16px; color:#fff; font-weight:600;">Vamos identificar voc√™?</p>
        <p style="font-size:13px; color:#ccc; margin-top:5px;">Para liberar o envio, digite seu <strong>e-mail de acesso ao Clube</strong>.</p>
      </div>

      <div class="form-group">
        <input type="email" id="emailInput" class="form-input" placeholder="seu@email.com">
      </div>
      
      <button id="btnValidate" class="btn-main" onclick="validateUser()">
        Buscar meu cadastro
      </button>
      
      <div id="validationError" class="msg-box msg-error" style="display:none;"></div>
    </div>

    <!-- 2. TELA: N√ÉO ENCONTRADO (Ajuda) -->
    <div id="step-upsell">
      <div class="upsell-box">
        <div class="upsell-title">ü§î Ops! N√£o encontramos...</div>
        <p style="font-size:15px; line-height:1.5;">
          Procuramos pelo e-mail:<br>
          <strong id="displayEmailUpsell" style="color:#d32f2f;"></strong>
        </p>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <p style="font-size:14px; color:#555;">
          Tem certeza que digitou certo? Precisa ser <strong>exatamente o mesmo e-mail</strong> que voc√™ usa para entrar no curso.
        </p>
        
        <button class="btn-retry" onclick="resetView()">Ah, entendi! Corrigir e-mail</button>
      </div>
    </div>

    <!-- 3. TELA: UPLOAD (Liberado) -->
    <div id="step-upload">
      <div class="welcome-msg">üëã Oi, <span id="studentNameDisplay">Aluno</span>!</div>
      <p class="lesson-info">
        Tudo certo. Pode enviar seu v√≠deo para a aula:<br>
        <strong style="color:#fff; font-size:16px;" id="lessonNameDisplay">...</strong>
      </p>

      <label for="fileInput" class="btn-main">
        <span style="margin-right:10px; font-size:20px;">üì§</span> SELECIONAR V√çDEO
      </label>
      <input id="fileInput" type="file" accept="video/*" style="display:none;" />

      <div id="progressArea" class="progress-container" style="display:none;">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; color:#FF6D00;">
          <span>Subindo v√≠deo... n√£o feche essa janela.</span><span id="percentageText">0%</span>
        </div>
        <progress id="progressBar" value="0" max="100"></progress>
      </div>
      
      <div id="uploadError" class="msg-box msg-error" style="display:none;"></div>
    </div>

    <!-- 4. TELA: SUCESSO -->
    <div id="step-success">
      <div style="background:#2e7d32; border:1px solid #4caf50; padding:20px; border-radius:8px; display:flex; flex-direction:column; align-items:center; margin-top:5px; text-align:center;">
        <div style="font-size:40px; margin-bottom:10px;">‚úÖ</div>
        <div>
          <h3 style="color:#fff; font-size:20px; margin:0 0 5px 0; font-weight:800;">V√≠deo Enviado!</h3>
          <p style="color:#e8f5e9; font-size:14px; line-height:1.4; margin:0;">
            Recebemos seu arquivo.<br>
            Fique de olho no seu Zap/Email para a an√°lise.
          </p>
        </div>
      </div>
    </div>

  </div>

  <script>
    // =========================================================
    // CONFIGURA√á√ïES (Suas URLs Originais)
    // =========================================================
    
    // 1. URL DO APPS SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbypzt5_0sxbVkS-MM_CJjO9xFY0peVrMqUDa5uq7L44LdQKCBoK99x3gGt75Ns2wjYN8g/exec"; 
    
    // 2. URL DO SERVIDOR DE UPLOAD
    const TUS_ENDPOINT = "https://tus-upload-server-1019908552664.southamerica-east1.run.app/files/";

    // =========================================================

    // Vari√°veis Globais
    let currentStudentName = "";
    let currentStudentEmail = "";
    let currentLesson = "Aula Geral";

    // Pega o nome da aula que vem do link da Hotmart
    const params = new URLSearchParams(window.location.search);
    if(params.get('aula')) currentLesson = params.get('aula');

    // Elementos da Tela
    const els = {
      email: document.getElementById('emailInput'),
      btnVal: document.getElementById('btnValidate'),
      valErr: document.getElementById('validationError'),
      nameDisplay: document.getElementById('studentNameDisplay'),
      lessonDisplay: document.getElementById('lessonNameDisplay'),
      file: document.getElementById('fileInput'),
      bar: document.getElementById('progressBar'),
      txt: document.getElementById('percentageText'),
      prog: document.getElementById('progressArea'),
      upErr: document.getElementById('uploadError'),
      upsellEmail: document.getElementById('displayEmailUpsell')
    };

    els.lessonDisplay.innerText = currentLesson;

    // Fun√ß√£o para trocar as telas
    function showView(name) {
      ['step-validation', 'step-upsell', 'step-upload', 'step-success'].forEach(id => {
        document.getElementById(id).classList.remove('active');
      });
      document.getElementById('step-' + name).classList.add('active');
    }

    function resetView() {
      els.email.value = "";
      els.valErr.style.display = 'none';
      showView('validation');
    }

    // Verifica erros comuns de digita√ß√£o
    function checkTypos(email) {
      const typos = ['@gmial', '@gamil', '@gmal', '@hotmial', '@hotmil', '@outlok', '.cmo', '.combr', 'gmail.com.br'];
      for (let t of typos) { if (email.includes(t)) return t; }
      return null;
    }

    // --- L√ìGICA DE IDENTIFICA√á√ÉO ---
    async function validateUser() {
      const email = els.email.value.trim().toLowerCase();
      els.valErr.style.display = 'none';
      els.email.classList.remove('error');

      // Verifica√ß√µes b√°sicas
      if (!email || !email.includes('@') || !email.includes('.')) {
        els.valErr.innerHTML = "‚ö†Ô∏è Por favor, digite um e-mail v√°lido.";
        els.valErr.style.display = 'block';
        return;
      }

      const typo = checkTypos(email);
      if (typo) {
        els.valErr.innerHTML = `‚ö†Ô∏è Parece haver um errinho: <strong>${typo}</strong>? Verifique a digita√ß√£o.`;
        els.valErr.style.display = 'block';
        return;
      }

      // Efeito de carregamento
      els.btnVal.disabled = true;
      els.btnVal.innerHTML = "Buscando aluno...";

      try {
        // Pergunta pra planilha: "Esse aluno existe?"
        const res = await fetch(`${API_URL}?email=${encodeURIComponent(email)}`);
        const data = await res.json();

        if (data.valid) {
          // SUCESSO: Achou!
          currentStudentName = data.name; 
          currentStudentEmail = email;
          
          // Mostra s√≥ o primeiro nome pra ser mais pessoal
          els.nameDisplay.innerText = currentStudentName.split(' ')[0]; 
          showView('upload');
        } else {
          // ERRO: N√£o achou
          els.upsellEmail.innerText = email;
          showView('upsell');
        }

      } catch (err) {
        console.error(err);
        els.valErr.innerHTML = "‚ùå Erro de conex√£o. Verifique sua internet.";
        els.valErr.style.display = 'block';
      } finally {
        els.btnVal.disabled = false;
        els.btnVal.innerHTML = "Buscar meu cadastro";
      }
    }

    // --- L√ìGICA DE UPLOAD ---
    els.file.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Prepara a tela de progresso
      els.prog.style.display = 'block';
      els.upErr.style.display = 'none';
      document.querySelector("label[for='fileInput']").style.display = 'none'; // Esconde bot√£o pra n√£o clicar 2x

      const upload = new tus.Upload(file, {
        endpoint: TUS_ENDPOINT,
        chunkSize: 10485760, // 10MB por peda√ßo
        metadata: {
          filename: file.name,
          filetype: file.type,
          // Enviamos os dados validados (o Python vai ler isso)
          student_name: currentStudentName,
          student_email: currentStudentEmail,
          lesson: currentLesson,
          upload_date: new Date().toISOString()
        },
        onError: (error) => {
          console.error("Erro TUS: " + error);
          els.upErr.innerHTML = "‚ùå Ocorreu uma falha no envio. Verifique sua internet.";
          els.upErr.style.display = 'block';
          // Mostra o bot√£o de novo
          document.querySelector("label[for='fileInput']").style.display = 'flex'; 
        },
        onProgress: (bytesUploaded, bytesTotal) => {
          var percentage = (bytesUploaded / bytesTotal * 100).toFixed(0);
          els.bar.value = percentage;
          els.txt.innerText = percentage + "%";
        },
        onSuccess: () => {
          showView('success');
        }
      });

      upload.start();
    });

  </script>
</body>
</html>
